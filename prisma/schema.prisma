// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SystemConfig {
  id              String   @id @default(uuid())
  isInitialized   Boolean  @default(false)
  initializedAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("system_config")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  roles       Role[]
  permissions Permission[]

  @@index([slug])
  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  firstName    String
  lastName     String
  tenantId     String?
  isSuperAdmin Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant         Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles      UserRole[]
  refreshTokens  RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  profile        UserProfile?

  @@index([email, tenantId])
  @@index([tenantId, createdAt])
  @@index([isSuperAdmin])
  @@map("users")
}

model UserProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  companyName   String?
  age           Int?
  cnic          String?
  mobileNo      String?
  phoneNo       String?
  city          String?
  address       String?
  whatsappNo    String?
  facebookUrl   String?
  instagramUrl  String?
  twitterUrl    String?
  linkedinUrl   String?
  dateOfBirth   DateTime?
  bio           String?
  website       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([name, tenantId])
  @@index([tenantId, name])
  @@index([tenantId, createdAt])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String
  resource    String
  action      String
  description String?
  tenantId    String

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@index([tenantId, resource])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

